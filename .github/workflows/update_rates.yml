name: Update Exchange Rates

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: main  # We need the scraper script from main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install requests beautifulsoup4; fi

      - name: Run Scraper
        env:
          IQAIR_API_KEY: ${{ secrets.IQAIR_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: python scripts/scraper.py

      - name: Push to Data Branch
        run: |
           # 1. We have the new public/rates.json generated in the current workspace (main branch)
           NEW_RATES_PATH=$(pwd)/public/rates.json

           # 2. Setup a separate directory for the data branch
           mkdir -p ../data-branch
           cd ../data-branch

           # 3. Initialize git
           git init
           git config user.name 'github-actions[bot]'
           git config user.email 'github-actions[bot]@users.noreply.github.com'
           git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

           # 4. Fetch the data branch if it exists
           git fetch origin rates-data || echo "Branch rates-data does not exist yet"

           # 5. Checkout or create orphan
           if git show-ref --verify --quiet refs/remotes/origin/rates-data; then
             git checkout -b rates-data origin/rates-data
           else
             git checkout --orphan rates-data
             # Remove all files from the index/worktree to truly be orphan
             git rm -rf . || true
           fi

           # 6. Copy the new file
           mkdir -p public
           cp "$NEW_RATES_PATH" public/rates.json

           # 7. Commit and Push
           git add public/rates.json
           if git diff --staged --quiet; then
             echo "No changes in rates.json"
           else
             git commit -m "Update exchange rates"
             git push -u origin rates-data
           fi
